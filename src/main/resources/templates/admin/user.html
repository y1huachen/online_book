<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="layout :: htmlhead(~{::title},~{::style})">
    <style>
        .layui-form-label{
            width: 100px;
        }
        .layui-table th {
            text-align: center;
        }
    </style>
    <title>用户管理</title>
</head>
<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin">
    <!--头-->
    <div th:replace="admin/fragments/head :: header"></div>
    <div class="layui-body">
        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
            <legend>所有用户</legend>
        </fieldset>
        <div style="text-align: center;">
            <div class="layui-inline">
                <table class="layui-table" style="table-layout:fixed;">
                    <colgroup>
                        <col width="150">
                        <col width="150">
                        <col width="200">
                        <col width="100">
                        <col>
                    </colgroup>
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>管理员</th>
                        <th>密码</th>
                        <th>头像</th>
                    </tr>
                    </thead>
                    <tbody id="userList">
                    <tr>
                        <td>1</td>
                        <td>lican</td>
                        <td>123456</td>
                        <td>none</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div id="pageList"></div>
        <div style="margin: 10px">
            <button type="button" class="layui-btn layui-btn-radius" id="btn-add">添加用户</button>
        </div>
    </div>
    <!--底部-->
    <div th:replace="admin/fragments/footer :: footer"></div>
</div>
<script>
    layui.use(['laypage', 'layer', 'form', 'element'], function(){
        var laypage = layui.laypage
            ,layer = layui.layer
            ,$ = layui.$
            ,form = layui.form
            ,element = layui.element;

        element.init();

        //监听提交
        form.on('submit(add)', function(data){
            $.ajax({
                url:'/admin/user/add',
                type:'POST',
                dataType:'json',
                data:{username:data.field.username,password:data.field.password},
                success:function (data) {
                    console.log(data);
                    if(data!=null){
                        layer.closeAll('loading');
                        layer.load(2);
                        layer.msg("添加成功", {icon: 6});
                        setTimeout(function(){
                            window.parent.location.reload();//修改成功后刷新父界面
                        }, 1000);
                        //加载层-风格

                    }else{
                        layer.msg("用户名已存在，换一个吧", {icon: 5});
                    }
                }
            })
            return false;
        });

        //添加用户
        $('#btn-add').on('click', function () {
            layer.open({
                type: 1,
                title: '添加用户',
                maxmin: true,
                area: ['420px', '330px'],
                shadeClose: false, //点击遮罩关闭
                content: $('#addUser'),
            });
        });
        function loadUser() {
            $.ajax({
                url:'/admin/user/find/all',
                type:'GET',
                success:function (data) {
                    console.log(data);
                    if(data!=null){
                        layer.closeAll('loading');
                        layer.msg("获取所有用户成功", {icon: 6,time: 1000});
                        //调用分页
                        laypage.render({
                            elem: 'pageList'
                            ,count: data.length
                            ,jump: function(obj){
                                //模拟渲染
                                document.getElementById('userList').innerHTML = function(){
                                    var arr = []
                                        ,thisData = data.concat().splice(obj.curr*obj.limit - obj.limit, obj.limit);
                                    layui.each(thisData, function(index, item){
                                        arr.push('<tr>'+ '<td>' + item['id'] + '</td>'
                                            + '<td>' + item['username'] + '</td>'
                                            + '<td>' + item['password'] + '</td>'
                                            + '<td>'
                                            + '<img src="/upload/images/'+ item['avatarUrl'] + '" class="layui-nav-img"/>'
                                            + '</td>'
                                            + '</tr>');
                                    });
                                    return arr.join('');
                                }();
                            }
                        });

                    }else{
                        layer.msg("获取所有用户失败", {icon: 5});
                    }
                }
            })
        }

        loadUser();

    });
</script>
<div id="addUser" style="display: none">
    <form class="layui-form" action="" style="margin-top:20px" method="post">
        <div class="layui-form-item">
            <label class="layui-form-label">用户名</label>
            <div class="layui-input-inline">
                <input type="text" name="username"  required  lay-verify="required" autocomplete="off" placeholder="请输入用户名" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">密码</label>
            <div class="layui-input-inline">
                <input type="text" name="password"  required  lay-verify="required" autocomplete="off" placeholder="请输入密码" class="layui-input">
            </div>
        </div>

        <div class="layui-form-item" style="margin-top:40px">
            <div class="layui-input-block">
                <button class="layui-btn  layui-btn-submit " lay-submit="" lay-filter="add">立即提交</button>
                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </div>
    </form>
</div>
</body>
</html>